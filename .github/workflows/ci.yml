name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    - cron: "31 7 * * 3"

permissions:
  contents: read

jobs:
  lint:
    name: Lint Codebase
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      statuses: write

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install Dependencies
        id: install
        run: npm ci

      - name: Lint Codebase
        id: super-linter
        uses: super-linter/super-linter/slim@d5b0a2ab116623730dd094f15ddc1b6b25bf7b99 # v8.3.2
        env:
          DEFAULT_BRANCH: main
          FILTER_REGEX_EXCLUDE: dist/**/*
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LINTER_RULES_PATH: ${{ github.workspace }}
          # Fallback DB registries for intermittent mirror.gcr.io outages.
          TRIVY_DB_REPOSITORY: mirror.gcr.io/aquasec/trivy-db:2,ghcr.io/aquasecurity/trivy-db:2,public.ecr.aws/aquasecurity/trivy-db:2
          VALIDATE_ALL_CODEBASE: true
          VALIDATE_JAVASCRIPT_ES: false
          VALIDATE_JSCPD: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_JSON: false
          VALIDATE_JAVASCRIPT_PRETTIER: false
          VALIDATE_TYPESCRIPT_PRETTIER: false
          VALIDATE_JSON_PRETTIER: false
          VALIDATE_YAML_PRETTIER: false
          VALIDATE_CHECKOV: false # not relevant as we don't use IaC
          VALIDATE_NATURAL_LANGUAGE: false

  check-dist:
    name: Check dist/
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install Dependencies
        id: install
        run: npm ci

      - name: Build dist/ Directory and Compare
        id: diff
        run: bash scripts/check-dist.sh

      - if: ${{ failure() && steps.diff.outcome == 'failure' }}
        name: Upload Artifact
        id: upload
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dist
          path: dist/

  codeql:
    name: CodeQL Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      checks: write
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language:
          - TypeScript

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Initialize CodeQL
        id: initialize
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          languages: ${{ matrix.language }}
          source-root: src

      - name: Autobuild
        id: autobuild
        uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9

      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9

  ci:
    name: CI
    if: github.event_name != 'schedule'
    needs:
      - lint
      - check-dist
      - codeql
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install Dependencies
        id: npm-ci
        run: npm ci

      - name: Test
        id: npm-test
        run: npm run test

      - name: Build CLI
        id: build-cli
        run: npm run package

      - name: Generate Auth Cookie
        id: auth-cookie
        if: github.actor != 'dependabot[bot]'
        run: |
          curl -s -o /dev/null \
            -X POST https://xcelera.dev/login \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d 'username=${{ secrets.XCELERA_AUTH_USER }}&password=${{ secrets.XCELERA_AUTH_PASSWORD }}' \
            -c cookies.txt

      - name: Run CLI
        id: run-cli
        if: github.actor != 'dependabot[bot]'
        run: node dist/cli.js audit --ref xcelera-profile-page --cookie-file cookies.txt
        env:
          XCELERA_TOKEN: ${{ secrets.XCELERA_TOKEN }}
          DEBUG: true

      - name: Test Local Action
        id: test-action
        if: github.actor != 'dependabot[bot]'
        uses: ./
        with:
          ref: xcelera-api-tokens
          token: ${{ secrets.XCELERA_TOKEN }}
          cookie-file: cookies.txt

      - name: Cleanup Auth Cookie
        id: cleanup-cookie
        if: github.actor != 'dependabot[bot]'
        run: rm -f cookies.txt

      - name: Print Output
        id: output
        if: github.actor != 'dependabot[bot]' # Dependabot doesn't have access to secrets
        run: echo "${STEPS_TEST_ACTION_OUTPUTS_STATUS}"
        env:
          STEPS_TEST_ACTION_OUTPUTS_STATUS: ${{ steps.test-action.outputs.status }}

  release:
    name: Release
    needs:
      - ci
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: false

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install dependencies
        run: npm clean-install

      - name: Verify the integrity of provenance attestations and registry
          signatures for installed dependencies
        run: npm audit signatures

      - name: package
        run: npm run package

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
